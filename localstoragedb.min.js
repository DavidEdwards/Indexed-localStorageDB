/*
	Kailash Nadh (http://nadh.in)
	Del Bianco Luca <vshjxyz@gmail.com> (Indexes Fork)
	David Edwards <knossos@gmail.com> (Indexes Fork - 2.3.1 merge)

	localStorageDB v 2.3.1
	A simple database layer for localStorage

	v 2.3.1 Mar 2015
	v 2.3 Feb 2014 Contribution: Christian Kellner (http://orange-coding.net)
	v 2.2 Jan 2014 Contribution: Andy Hawkins (http://a904guy.com) 
	v 2.1 Nov 2013
	v 2.0 June 2013
	v 1.9 Nov 2012

	License	:	MIT License
*/

!function(a,b){function c(a,c){function i(){h.hasOwnProperty(e)&&delete h[e],g=null}function j(){var a=0;for(var b in g.tables)g.tables.hasOwnProperty(b)&&a++;return a}function k(a){return g.tables[a].fields}function l(a){return!!g.tables[a]}function m(a){l(a)||D("The table '"+a+"' does not exist")}function n(a,b){var c=!1,d=g.tables[a].fields;for(var e in d)if(d[e]==b){c=!0;break}return c}function o(a,b,c){for(var d={},e=0;e<c.length;e++)d[c[e]]={};g.tables[a]={fields:b,auto_increment:1,indexes:d},g.data[a]={}}function p(a){delete g.tables[a],delete g.data[a]}function q(a){g.tables[a].auto_increment=1,g.data[a]={}}function r(a,b,c){if(g.tables[a].fields=g.tables[a].fields.concat(b),"undefined"!=typeof c)for(var d in g.data[a])if(g.data[a].hasOwnProperty(d))for(var e in b)"object"==typeof c?g.data[a][d][b[e]]=c[b[e]]:g.data[a][d][b[e]]=c}function s(a){var b=0;for(var c in g.data[a])g.data[a].hasOwnProperty(c)&&b++;return b}function t(a,c){c.ID=g.tables[a].auto_increment,g.data[a][g.tables[a].auto_increment]=c,g.tables[a].auto_increment++;for(var d in g.tables[a].indexes)c.hasOwnProperty(d)&&(g.tables[a].indexes[d][c[d]]===b&&(g.tables[a].indexes[d][c[d]]=[]),g.tables[a].indexes[d][c[d]].indexOf(c.ID)==-1&&g.tables[a].indexes[d][c[d]].push(c.ID));return c.ID}function u(a,c,d,e,f,h){for(var i=null,j=[],k=null,l=0;l<c.length;l++)i=c[l],k=g.data[a][i],j.push(E(k));if(f&&f instanceof Array)for(var l=0;l<f.length;l++)j.sort(v(f[l][0],f[l].length>1?f[l][1]:null));if(h&&h instanceof Array){for(var m=0;m<h.length;m++)for(var n={},o=h[m],l=0;l<j.length;l++)j[l]!==b&&(j[l].hasOwnProperty(o)&&n.hasOwnProperty(j[l][o])?delete j[l]:n[j[l][o]]=1);for(var p=[],l=0;l<j.length;l++)j[l]!==b&&p.push(j[l]);j=p}return d=d&&"number"==typeof d?d:null,e=e&&"number"==typeof e?e:null,d&&e?j=j.slice(d,d+e):d?j=j.slice(d):e&&(j=j.slice(d,e)),j}function v(a,b){return function(c,d){var e="string"==typeof c[a]?c[a].toLowerCase():c[a],f="string"==typeof d[a]?d[a].toLowerCase():d[a];return"DESC"===b?e==f?0:e<f?1:-1:e==f?0:e>f?1:-1}}function w(a,b){var c=[],d=!1,e=null,f=[],h=!1;for(var i in g.tables[a].indexes)if(b.hasOwnProperty(i)&&g.tables[a].indexes[i].hasOwnProperty(b[i])){h=!0;for(var j=0;j<g.tables[a].indexes[i][b[i]].length;j++)f[g.tables[a].indexes[i][b[i]][j]]=null}0!=f.length||h||(f=g.data[a]);for(var k in f)if(g.data[a].hasOwnProperty(k)){e=g.data[a][k],d=!0;for(var l in b)if(b.hasOwnProperty(l))if("string"==typeof b[l]){if(null===e[l]||e[l].toString().toLowerCase()!=b[l].toString().toLowerCase()){d=!1;break}}else if(e[l]!=b[l]){d=!1;break}d&&c.push(k)}return c}function x(a,b){var c=[],e=null;for(var f in g.data[a])g.data[a].hasOwnProperty(f)&&(e=g.data[a][f],1==b(E(e))&&c.push(f));return c}function y(a){var b=[];for(var c in g.data[a])g.data[a].hasOwnProperty(c)&&b.push(c);return b}function z(a,b){for(var c=0;c<b.length;c++){for(var d in g.data[a][b[c]])if(g.tables[a].indexes.hasOwnProperty(d)){var e=g.tables[a].indexes[d][g.data[a][b[c]][d]].indexOf(Number(b[c]));e>-1&&delete g.tables[a].indexes[d][g.data[a][b[c]][d]][e]}g.data[a].hasOwnProperty(b[c])&&delete g.data[a][b[c]]}return b.length}function A(a,b,c){for(var d="",e=0,f=0;f<b.length;f++){d=b[f];var h=c(E(g.data[a][d]));if(h){delete h.ID;var i=g.data[a][d];for(var j in g.tables[a].indexes)h.hasOwnProperty(j)&&(delete g.tables[a].indexes[j][i[j]][d],g.tables[a].indexes[j][h[j]][d]=null);for(var k in h)h.hasOwnProperty(k)&&(i[k]=h[k]);g.data[a][d]=G(a,i),e++}}return e}function B(){try{return h.setItem(e,JSON.stringify(g)),!0}catch(a){return!1}}function C(){return JSON.stringify(g)}function D(a){throw new Error(a)}function E(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function F(a){return!a.toString().match(/[^a-z_0-9]/gi)}function G(a,c){for(var d="",e={},f=0;f<g.tables[a].fields.length;f++)d=g.tables[a].fields[f],c[d]!==b&&(e[d]=c[d]);return e}function H(a,c){for(var d="",e={},f=0;f<g.tables[a].fields.length;f++)d=g.tables[a].fields[f],e[d]=null===c[d]||c[d]===b?null:c[d];return e}var d="db_",e=d+a,f=!1,g=null;try{var h=c==sessionStorage?sessionStorage:localStorage}catch(a){var h=c}return g=h[e],g&&(g=JSON.parse(g))&&g.tables&&g.data||(F(a)?(g={tables:{},data:{}},B(),f=!0):D("The name '"+a+"' contains invalid characters")),{commit:function(){return B()},isNew:function(){return f},drop:function(){i()},serialize:function(){return C()},tableExists:function(a){return l(a)},tableFields:function(a){return k(a)},tableCount:function(){return j()},columnExists:function(a,b){return n(a,b)},createTable:function(a,c,d){var e=!1;if(d===b&&(d=[]),F(a))if(this.tableExists(a))D("The table name '"+a+"' already exists.");else{for(var f=!0,g=0;g<c.length;g++)if(!F(c[g])){f=!1;break}for(var h=0;h<d.length;h++)c.indexOf(d[h])<0&&D('The index "'+d[h]+'" does not bind with any field in the table');if(f){for(var i={},g=0;g<c.length;g++)i[c[g]]=!0;delete i.ID,c=["ID"];for(var j in i)i.hasOwnProperty(j)&&c.push(j);o(a,c,d),e=!0}else D("One or more field names in the table definition contains invalid characters")}else D("The database name '"+a+"' contains invalid characters.");return e},createTableWithData:function(a,b,c){("object"!=typeof b||!b.length||b.length<1)&&D("Data supplied isn't in object form. Example: [{k:v,k:v},{k:v,k:v} ..]");var d=Object.keys(b[0]);if(this.createTable(a,d,c)){this.commit();for(var e=0;e<b.length;e++)t(a,b[e])||D("Failed to insert record: ["+JSON.stringify(b[e])+"]");this.commit()}return!0},dropTable:function(a){m(a),p(a)},truncate:function(a){m(a),q(a)},alterTable:function(a,b,c){var d=!1;if(F(a)){if("object"==typeof b){for(var e=!0,f=0;f<b.length;f++)if(!F(b[f])){e=!1;break}if(e){for(var g={},f=0;f<b.length;f++)g[b[f]]=!0;delete g.ID,b=[];for(var h in g)g.hasOwnProperty(h)&&b.push(h);r(a,b,c),d=!0}else D("One or more field names in the table definition contains invalid characters")}else if("string"==typeof b)if(F(b)){var i=[];i.push(b),r(a,i,c),d=!0}else D("One or more field names in the table definition contains invalid characters")}else D("The database name '"+a+"' contains invalid characters");return d},rowCount:function(a){return m(a),s(a)},insert:function(a,b){return m(a),t(a,H(a,b))},insertOrUpdate:function(a,b,c){m(a);var d=[];if(b?"object"==typeof b?d=w(a,G(a,b)):"function"==typeof b&&(d=x(a,b)):d=y(a),0==d.length)return t(a,H(a,c));var e=[];return A(a,d,function(a){return e.push(a.ID),c}),e},update:function(a,b,c){m(a);var d=[];return b?"object"==typeof b?d=w(a,G(a,b)):"function"==typeof b&&(d=x(a,b)):d=y(a),A(a,d,c)},query:function(a,b,c,d,e,f){m(a);var g=[];return b?"object"==typeof b?g=w(a,G(a,b),c,d):"function"==typeof b&&(g=x(a,b,c,d)):g=y(a,c,d),u(a,g,d,c,e,f)},queryAll:function(a,b){return b?this.query(a,b.hasOwnProperty("query")?b.query:null,b.hasOwnProperty("limit")?b.limit:null,b.hasOwnProperty("start")?b.start:null,b.hasOwnProperty("sort")?b.sort:null,b.hasOwnProperty("distinct")?b.distinct:null):this.query(a)},deleteRows:function(a,b){m(a);var c=[];return b?"object"==typeof b?c=w(a,G(a,b)):"function"==typeof b&&(c=x(a,b)):c=y(a),z(a,c)}}}"function"==typeof define&&define.amd?define(function(){return c}):a.localStorageDB=c,Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){null==b?b=0:b<0&&(b=Math.max(0,this.length+b));for(var c=b,d=this.length;c<d;c++)if(this[c]===a)return c;return-1})}(window);